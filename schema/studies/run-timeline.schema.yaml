$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://computable-lab.com/schema/computable-lab/run-timeline.schema.yaml"
title: "RunTimeline"
description: >
  Ordered activities for a Run. Canonical timeline for plate events, acquisitions, and sample operations within the run.

type: object
additionalProperties: false
allOf:
- $ref: "./common.schema.yaml#/$defs/FAIRCommon"

required: [ kind, recordId, runId, activities ]

properties:
  kind:
    const: "run-timeline"

  recordId:
    type: string

  runId:
    type: string

  activities:
    type: array
    minItems: 1
    items:
      $ref: "#/$defs/activity"

$defs:
  # -------------------------
  # Helpers (move in from old schema)
  # -------------------------
  file_ref:
    type: object
    # ...

  material_ref:
    $ref: "../datatypes/material-ref.schema.yaml"

  labware_ref:
    $ref: "../datatypes/labware-ref.schema.yaml"

  plate_event:
    $ref: "../datatypes/plate-event.schema.yaml"

  # -------------------------
  # Activity union
  # -------------------------
  activity:
    type: object
    required: [ id, kind ]
    properties:
      id:
        type: string
      kind:
        type: string
        enum: [ protocol_segment, acquisition, sample_operation ]
      label:
        type: string
      started_at:
        type: string
        format: date-time
      ended_at:
        type: string
        format: date-time
      notes:
        type: string
    additionalProperties: true
    allOf:
    - oneOf:
      - $ref: "#/$defs/protocol_segment_activity"
      - $ref: "#/$defs/acquisition_activity"
      - $ref: "#/$defs/sample_operation_activity"

  # -------------------------
  # Protocol segment activity
  # -------------------------
  protocol_ref:
    type: object
    additionalProperties: false
    required: [ "@id" ]
    properties:
      "@id": { type: string }
      family: { type: string }
      version: { type: string }
      label: { type: string }

  protocol_segment_activity:
    type: object
    additionalProperties: false
    required: [ kind, protocol, plate_events ]
    properties:
      kind:
        const: "protocol_segment"
      protocol:
        $ref: "#/$defs/protocol_ref"
      labware_bindings:
        type: object
        additionalProperties: { type: string }
      parameters:
        type: object
        additionalProperties: true
      plate_events:
        type: array
        items: { $ref: "#/$defs/plate_event" }
      derived_cache:
        type: object
        additionalProperties: false
        properties:
          is_cache: { const: true }
          derived_from: { type: string }
          files:
            type: array
            items: { $ref: "#/$defs/file_ref" }
      outputs:
        type: object
        additionalProperties: false
        properties:
          files:
            type: array
            items: { $ref: "#/$defs/file_ref" }

  # -------------------------
  # Acquisition activity
  # -------------------------
  acquisition_slice:
    type: object
    additionalProperties: false
    required: [ timepoint ]
    properties:
      timepoint: { type: string }
      acquired_at: { type: string, format: date-time }
      files:
        type: array
        items: { $ref: "#/$defs/file_ref" }
      metrics:
        type: object
        additionalProperties: true
      settings:
        type: object
        additionalProperties: true

  acquisition_activity:
    type: object
    additionalProperties: false
    required: [ kind, acquisition_type ]
    properties:
      kind:
        const: "acquisition"
      acquisition_type:
        type: string
        minLength: 1
      modality:
        type: string
        enum: [ fluorescence, absorbance, luminescence, microscopy, ms, qpcr, other ]
      features_measured:
        type: array
        items: { type: string }
      materials_used:
        type: array
        items: { type: string }
      instrument:
        type: string
      labware:
        $ref: "#/$defs/labware_ref"
      mode:
        type: string
      channels:
        type: array
        items: { type: string }
      acquisitions:
        type: array
        items: { $ref: "#/$defs/acquisition_slice" }
      files:
        type: array
        items: { $ref: "#/$defs/file_ref" }
      derived_from_plate_events:
        type: array
        items: { type: string }
      input_samples:
        type: array
        items: { type: string }

  # -------------------------
  # Sample operation activity
  # -------------------------
  sample_ref:
    type: object
    additionalProperties: false
    required: [ "@id" ]
    properties:
      "@id": { type: string }
      label: { type: string }
      record_ref: { type: string }
      material: { $ref: "#/$defs/material_ref" }
      volume: { type: string }
      notes: { type: string }

  sample_operation_activity:
    type: object
    additionalProperties: false
    required: [ kind, operation ]
    properties:
      kind:
        const: "sample_operation"
      operation:
        type: string
        minLength: 1
      from:
        type: object
        additionalProperties: false
        properties:
          labware: { $ref: "#/$defs/labware_ref" }
          wells:
            type: array
            items: { type: string }
          description: { type: string }
      produced_samples:
        type: array
        items: { $ref: "#/$defs/sample_ref" }
      splits:
        type: array
        items:
          type: object
          additionalProperties: false
          required: [ sample ]
          properties:
            sample: { $ref: "#/$defs/sample_ref" }
            fraction: { type: string }
      destination:
        type: object
        additionalProperties: false
        properties:
          target: { type: string }
          notes: { type: string }
      files:
        type: array
        items: { $ref: "#/$defs/file_ref" }
      plate_events:
        type: array
        items: { $ref: "#/$defs/plate_event" }
