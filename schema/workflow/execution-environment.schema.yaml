$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://computable-lab.com/schema/computable-lab/execution-environment.schema.yaml"
title: "ExecutionEnvironment"
description: >
  Declarative robot/workcell capability descriptor used to validate and bind
  execution plans. Stable across runs until hardware/configuration changes.

type: object
additionalProperties: false

required:
- kind
- recordId
- type
- id
- version
- robot
- deck
- tools
- labware_registry

properties:
  kind:
    const: "execution-environment"

  recordId:
    type: string
    description: "Canonical record identity for computable-lab storage."

  type:
    const: "execution_environment"

  id:
    type: string
    pattern: "^[A-Z0-9._-]{6,}$"

  version:
    type: string
    pattern: "^[0-9]+\\.[0-9]+\\.[0-9]+$"

  created_at:
    type: string
    format: date-time

  created_by:
    type: string

  robot:
    type: object
    additionalProperties: false
    required: [ family, model ]
    properties:
      family:
        type: string
        enum: [ opentrons_ot2, opentrons_flex, integra_assist_plus, pylabrobot_generic ]
      model:
        type: string
      serial:
        type: string
      runtime_targets:
        type: array
        items:
          type: string
          enum: [ pylabrobot, pyalab, opentrons_api ]
        uniqueItems: true

  deck:
    type: object
    additionalProperties: false
    required: [ deck_id, slots ]
    properties:
      deck_id:
        type: string
      slots:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [ slot_id, slot_type, compatible_footprints ]
          properties:
            slot_id:
              type: string
            slot_type:
              type: string
              enum: [ standard, special, trash, heater, magnet, hotel ]
            compatible_footprints:
              type: array
              minItems: 1
              items: { type: string }
              uniqueItems: true
            notes:
              type: string
      calibration_set_ref:
        type: string

  tools:
    type: array
    minItems: 1
    items:
      type: object
      additionalProperties: false
      required: [ tool_id, tool_type ]
      properties:
        tool_id:
          type: string
        tool_type:
          type: string
          enum: [ pipette, head, gripper ]
        channels:
          type: integer
          minimum: 1
        mount:
          type: string
          enum: [ left, right, center, na ]
        volume_min_ul:
          type: number
          minimum: 0
        volume_max_ul:
          type: number
          minimum: 0
        tip_types:
          type: array
          items: { type: string }
          uniqueItems: true
        liquid_classes:
          type: array
          items: { type: string }
          uniqueItems: true

  labware_registry:
    type: object
    additionalProperties: false
    required: [ definitions ]
    properties:
      definitions:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [ labware_id, footprint, definition_ref ]
          properties:
            labware_id:
              type: string
            footprint:
              type: string
            definition_ref:
              type: string
            vendor:
              type: string
            version:
              type: string

  constraints:
    type: object
    additionalProperties: false
    properties:
      max_labware_items:
        type: integer
        minimum: 1
      max_tipracks:
        type: integer
        minimum: 0
      requires_trash_slot:
        type: boolean
      forbidden_slot_ids:
        type: array
        items: { type: string }
        uniqueItems: true
      notes:
        type: string

  hash:
    type: string
