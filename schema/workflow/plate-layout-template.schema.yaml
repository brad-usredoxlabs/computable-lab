$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://computable-lab.com/schema/computable-lab/plate-layout-template.schema.yaml"
title: "Plate Layout Template"
description: >
  Reusable declarative plate/reservoir pattern. Templates encode intended well contents,
  roles, and lane groupings independent of a specific execution run.

type: object
unevaluatedProperties: false
allOf:
- $ref: "./common.schema.yaml#/$defs/FAIRCommon"

required: [ kind, recordId, title, labware_ref, assignments ]

properties:
  kind:
    const: "plate-layout-template"

  recordId:
    type: string
    description: "Stable template identifier (e.g., PLT-DRUGLIB-96-V1)."

  title:
    type: string

  version:
    type: string

  labware_ref:
    $ref: "./datatypes/ref.schema.yaml"
    description: "Labware geometry/design this template targets."

  assignment_mode:
    type: string
    enum: [ explicit, parameterized, hybrid ]
    default: explicit

  binding_slots:
    type: array
    description: "Unbound symbolic placeholders to resolve at run binding time."
    items:
      type: object
      additionalProperties: false
      required: [ slot_id ]
      properties:
        slot_id: { type: string }
        description: { type: string }
        expected_kind:
          type: string
          enum: [ material, material-lot, context, library-member ]
        allowed_refs:
          type: array
          items: { $ref: "./datatypes/ref.schema.yaml" }

  assignments:
    type: array
    minItems: 1
    items:
      $ref: "#/$defs/WellAssignment"

  lane_groups:
    type: array
    description: "Optional lane/replicate grouping metadata for execution UX."
    items:
      type: object
      additionalProperties: false
      required: [ lane_id, wells ]
      properties:
        lane_id: { type: string }
        label: { type: string }
        wells:
          type: array
          minItems: 1
          items: { type: string }
        replicate_index:
          type: integer
          minimum: 1

  tags:
    type: array
    items: { type: string }
    uniqueItems: true

$defs:
  WellSelector:
    oneOf:
    - type: object
      additionalProperties: false
      required: [ kind, wells ]
      properties:
        kind: { const: explicit }
        wells:
          type: array
          minItems: 1
          items: { type: string }
    - type: object
      additionalProperties: false
      required: [ kind, start, end ]
      properties:
        kind: { const: range }
        start: { type: string }
        end: { type: string }
    - type: object
      additionalProperties: false
      required: [ kind, region ]
      properties:
        kind: { const: region }
        region: { type: string }

  AssignmentInput:
    type: object
    additionalProperties: false
    required: [ source ]
    properties:
      source:
        type: string
        enum: [ material_ref, material_lot_ref, context_ref, binding_slot ]
      material_ref: { $ref: "./datatypes/ref.schema.yaml" }
      material_lot_ref: { $ref: "./datatypes/ref.schema.yaml" }
      context_ref: { $ref: "./datatypes/ref.schema.yaml" }
      binding_slot: { type: string }
      role:
        type: string
        enum: [ sample, positive_control, negative_control, vehicle_control, blank, standard_curve, treatment, other ]
      amount:
        type: object
        additionalProperties: false
        required: [ value, unit ]
        properties:
          value: { type: number }
          unit: { type: string }
      concentration:
        type: object
        additionalProperties: false
        required: [ value, unit ]
        properties:
          value: { type: number }
          unit: { type: string }

  WellAssignment:
    type: object
    additionalProperties: false
    required: [ selector, inputs ]
    properties:
      selector:
        $ref: "#/$defs/WellSelector"
      inputs:
        type: array
        minItems: 1
        items: { $ref: "#/$defs/AssignmentInput" }
      notes: { type: string }
