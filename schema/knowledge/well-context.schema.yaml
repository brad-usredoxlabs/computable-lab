$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://computable-lab.com/schema/computable-lab/well-context.schema.yaml"
title: "WellContext"
description: >
  Derived state for a specific well at a specific time. WellContext is computed from canonical events. It may cache derived state, but must reference its provenance.

type: object
additionalProperties: false
allOf:
- $ref: "./common.schema.yaml#/$defs/FAIRCommon"

required: [ kind, id, location, derived_from, time ]

properties:
  kind:
    const: "well_context"

  id:
    type: string
    description: "Stable identifier for this context (e.g., WC-PLT-96-01-A01)."

  location:
    type: object
    additionalProperties: false
    required: [ plate, well ]
    properties:
      plate:
        $ref: "./datatypes/ref.schema.yaml"
      well:
        type: string

  derived_from:
    type: object
    additionalProperties: false
    required: [ events ]
    properties:
      events:
        type: array
        minItems: 1
        items:
          $ref: "./datatypes/ref.schema.yaml"
        uniqueItems: true

  time:
    type: string
    format: date-time

  state:
    type: object
    description: "Optional cached derived state (not canonical truth)."
    additionalProperties: false
    properties:
      materials:
        type: array
        items:
          $ref: "#/$defs/ContextMaterial"
      tags:
        type: array
        items: { type: string }
        uniqueItems: true

$defs:
  ContextMaterial:
    type: object
    additionalProperties: false
    required: [ ref ]
    properties:
      ref:
        $ref: "./datatypes/ref.schema.yaml"
      amount:
        $ref: "./datatypes/amount.schema.yaml"
      concentration:
        $ref: "./datatypes/amount.schema.yaml"
