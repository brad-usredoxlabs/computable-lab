$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://computable-lab.com/schema/computable-lab/experiment-narrative.schema.yaml"
title: "ExperimentNarrative"
description: >
  A thin, curated narrative spine for an Experiment. This record does NOT duplicate run/event content. It provides ordering, curation, and lightweight rationale links by pointing to other records (runs, decisions, claims, evidence bundles, notes). Parents should not enumerate children; this narrative is optional and exists only when a human-readable storyline and/or audit trail is needed.

type: object
additionalProperties: false

allOf:
- $ref: "./common.schema.yaml#/$defs/FAIRCommon"

required:
- kind
- recordId
- experimentId
- entries

properties:
  kind:
    const: "experiment-narrative"
    description: "Record discriminator."

  recordId:
    type: string
    description: "Stable local identifier for this narrative record (e.g., EXPNAR-000123)."

  experimentId:
    type: string
    description: "Local ID of the parent Experiment (recordId of kind=experiment)."

  title:
    type: string
    description: "Optional human-friendly title for the narrative (e.g., 'Validate Assay: SCD1 story')."

  summary:
    type: string
    description: "Optional high-level abstract of the narrative."

  state:
    type: string
    description: "Optional workflow state (e.g., draft, in_review, accepted, superseded)."

  primaryClaimIds:
    type: array
    description: "Optional curated set of claim recordIds this narrative is primarily about."
    items:
      type: string
    uniqueItems: true

  tags:
    type: array
    description: "Optional tags for grouping and filtering."
    items:
      type: string
    uniqueItems: true

  entries:
    type: array
    description: >
      Ordered narrative entries. Each entry points to an existing record and optionally describes its role and rationale. Keep notes short; do not restate full results here.
    minItems: 1
    items:
      $ref: "#/$defs/NarrativeEntry"

$defs:
  NarrativeEntry:
    type: object
    additionalProperties: false
    required:
    - at
    - ref

    properties:
      at:
        type: string
        description: "Timestamp for ordering (ISO 8601). Use local timezone offsets where possible."
        format: date-time

      ref:
        type: string
        description: >
          Reference to a record that anchors this narrative step. Recommended: JSON-LD @id (CURIE/IRI), but a recordId is allowed if your resolver supports it. Examples: 'usrl:run/RUN-000041', 'usrl:decision/DEC-000008', 'RUN-000041'.

      role:
        type: string
        description: "How this referenced record functions in the story."
        enum:
        - "run"
        - "decision"
        - "claim"
        - "evidence"
        - "note"
        - "milestone"
        - "analysis"
        - "artifact"
        - "other"

      status:
        type: string
        description: "Optional outcome status for this narrative step."
        enum:
        - "planned"
        - "in_progress"
        - "completed"
        - "aborted"
        - "failed"
        - "superseded"

      note:
        type: string
        description: >
          Short human note (1â€“3 sentences) describing why this step matters. Avoid duplicating run logs.

      causedBy:
        type: array
        description: >
          Optional causal links to earlier narrative items or records (e.g., this run follows a decision). Use @id/CURIE or recordId.
        items:
          type: string
        uniqueItems: true

      supportsClaimIds:
        type: array
        description: "Optional list of claim recordIds that this entry supports."
        items:
          type: string
        uniqueItems: true

      contradictsClaimIds:
        type: array
        description: "Optional list of claim recordIds that this entry contradicts."
        items:
          type: string
        uniqueItems: true

      evidenceBundleIds:
        type: array
        description: "Optional evidence bundle recordIds relevant to this step."
        items:
          type: string
        uniqueItems: true

      attachments:
        type: array
        description: >
          Optional pointers to key artifacts (plots, reports, exports). Prefer stable URIs or repo-relative paths.
        items:
          $ref: "#/$defs/Attachment"
        uniqueItems: true

      importance:
        type: string
        description: "Optional curation signal for derived views."
        enum: [ "primary", "secondary", "background" ]

      track:
        type: string
        description: "Optional branch/thread label for parallel lines of work within the experiment."

  Attachment:
    type: object
    additionalProperties: false
    required:
    - href

    properties:
      href:
        type: string
        description: "URI, CURIE, or repo-relative path to the artifact."

      title:
        type: string
        description: "Optional human-friendly label for the artifact."

      mediaType:
        type: string
        description: "Optional media type (e.g., 'application/pdf', 'image/png')."
