# Agent Rules — computable-lab (Effective / Enforced)

Non-negotiable. If a change violates any rule below, it is incorrect even if the build passes.

## TL;DR (This Is What the Agent Must Actually Follow)
1. Specs first. Code second. Never the reverse.
2. No schema names, defaults, or business rules in TypeScript.
3. Everything is envelope-first.
4. Ajv is the sole validation authority.
5. Deterministic, pure, tested.
6. Never loosen types to silence errors.

---

## 0. First-Response Protocol (MANDATORY)
Before editing any TypeScript:
- Identify what belongs in schema / lint / UI specs.
- Propose spec changes first.
- Only then write minimal generic code.

Starting with TS is a failure.

## 1. Prime Directive
If it can be expressed as data/spec, it MUST be.

Code only:
- loads specs
- validates structurally (Ajv)
- interprets lint DSL
- renders UI from spec
- persists envelopes
- builds deterministic derivations

## 2. Schema Triplet
Every record has:
- *.schema.yaml
- *.lint.yaml
- *.ui.yaml

If not possible, explain why and propose a generic DSL extension.

## 3. No Hard-Coded Domain Logic
Forbidden in TS:
- schema-name branching
- inline schema-specific rules
- defaults or required-field logic
Business logic lives in lint YAML.

## 4. Envelope-First (CRITICAL)
- RecordEnvelope is canonical.
- recordId is identity.
- payload is opaque.
- metadata lives only in envelope.meta.
No smuggling fields between payload and envelope.

## 5. Determinism
No time, randomness, or environment-dependent logic in derivations.
All derivations are pure and tested.

## 6. Tests Are the Gate
Behavioral change → failing test first.
Never loosen types to silence errors.

## 7. exactOptionalPropertyTypes
Optional means absent OR value — never undefined.
Fix construction logic, not types.

## 8. No Dumping Grounds
Do not edit:
- src/types/**
- *types.ts / *utils.ts / *helpers.ts
unless a failing test proves the contract wrong.

## 9. Ajv Constitution
- Ajv is the single authority.
- No fake validation.
- No runtime Ajv mutation or hacks.
- Formats are startup-only.

## 10. Interface Integrity
Do not reshape interfaces to match broken code.
Fix implementations, not contracts.

## 11. No Type-System Resets (Critical)

When encountering TypeScript errors, the agent MUST NOT recreate,
duplicate, or redesign shared type definitions (e.g. `types.ts`,
`ValidationResult`, `JSONSchema`, `RecordEnvelope`) as a workaround.
Shared types are treated as authoritative contracts. Errors indicate
misuse or misunderstanding at the call site and MUST be fixed there,
not by redefining the contract.


## Definition of Done
- Specs first
- No domain logic in TS
- Envelope-first preserved
- Deterministic + tested
